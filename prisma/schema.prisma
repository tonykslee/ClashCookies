generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PlayerActivity {
  tag            String   @id
  name           String
  clanTag        String

  lastDonationAt DateTime?
  lastCapitalAt  DateTime?
  lastTrophyAt   DateTime?
  lastWarAt      DateTime?
  lastBuilderAt  DateTime?
  
  lastTrophies          Int?
  lastWarStars          Int?
  lastBuilderTrophies   Int?


  lastSeenAt     DateTime
  updatedAt      DateTime @updatedAt
}

model TrackedClan {
  id        Int      @id @default(autoincrement())
  tag       String   @unique
  name      String?
  createdAt DateTime @default(now())
}

model BotSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PlayerLink {
  playerTag      String   @id
  discordUserId  String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum KickListSource {
  AUTO_INACTIVE
  MANUAL
}

enum RecruitmentPlatform {
  discord
  reddit
  band
}

model KickListEntry {
  id            Int            @id @default(autoincrement())
  guildId       String
  playerTag     String
  playerName    String?
  clanTag       String?
  clanName      String?
  reason        String
  source        KickListSource
  daysThreshold Int?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([guildId, playerTag])
  @@index([guildId, source])
  @@unique([guildId, playerTag, source])
}

model RecruitmentTemplate {
  id         Int      @id @default(autoincrement())
  clanTag    String
  platform   RecruitmentPlatform
  subject    String?
  requiredTH String
  focus      String
  body       String
  imageUrls  String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([clanTag, platform])
  @@index([clanTag])
}

model RecruitmentCooldown {
  id        Int                 @id @default(autoincrement())
  userId    String
  clanTag   String
  platform  RecruitmentPlatform
  startedAt DateTime
  expiresAt DateTime
  reminded  Boolean             @default(false)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@unique([userId, clanTag, platform])
  @@index([userId, expiresAt])
  @@index([expiresAt, reminded])
}

model WarHistoryParticipant {
  id              Int      @id @default(autoincrement())
  clanTag         String
  clanName        String?
  opponentClanTag String?
  opponentClanName String?
  warStartTime    DateTime
  warEndTime      DateTime?
  warState        String?
  playerTag       String
  playerName      String?
  playerPosition  Int?
  attacksUsed     Int
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@unique([clanTag, warStartTime, playerTag])
  @@index([clanTag, warStartTime])
  @@index([playerTag, warStartTime])
}

model WarHistoryAttack {
  id               Int      @id @default(autoincrement())
  clanTag          String
  clanName         String?
  opponentClanTag  String?
  opponentClanName String?
  warStartTime     DateTime
  warEndTime       DateTime?
  warState         String?
  playerTag        String
  playerName       String?
  playerPosition   Int?
  attackOrder      Int
  attackNumber     Int
  defenderTag      String?
  defenderName     String?
  defenderPosition Int?
  stars            Int
  trueStars        Int
  destruction      Float
  attackSeenAt     DateTime
  updatedAt        DateTime @updatedAt
  createdAt        DateTime @default(now())

  @@unique([clanTag, warStartTime, playerTag, attackOrder])
  @@index([clanTag, warStartTime])
  @@index([playerTag, warStartTime])
}

model WarEventLogSubscription {
  id               Int      @id @default(autoincrement())
  guildId          String
  clanTag          String
  channelId        String
  enabled          Boolean  @default(true)
  currentSyncNumber Int?
  lastState        String?
  lastWarStartTime DateTime?
  lastOpponentTag  String?
  lastOpponentName String?
  lastClanName     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([guildId, clanTag])
  @@index([guildId, enabled])
}
